---
# tasks file for kubernetes

- name: Add K8s signing apt key
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Add K8s APT repo
  apt_repository:
    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Install K8s
  apt:
    name: kubelet,kubeadm,kubectl
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Holds K8s packages
  dpkg_selections:
    name:  kubelet,kubeadm,kubectl
    selection: hold

- name: K8s - restart kubelet
  systemd:
    state: restarted
    daemon_reload: yes
    name: kubelet

- name: Run kubeadm
  shell: kubeadm init --pod-network-cidr=172.19.0.0/16 --apiserver-advertise-address="{{ ansible_facts[\"eth0\"][\"ipv4\"][\"address\"] }}" --token="{{ token }}"
